stages:
  - build
  - release

variables:
  DOCKER_HOST: "tcp://docker:2376"
  DOCKER_TLS_VERIFY: "1"
  DOCKER_CERT_PATH: "/certs/client"
  DOCKER_IMAGE: "prplanit/apt-cacher-ng-oci"
  DOCKER_TAG: "$CI_COMMIT_TAG"
  GIT_TAG: "$CI_COMMIT_TAG"
  GITLAB_DOMAIN: "https://gitlab.prplanit.com"
  DOCKER_TLS_CERTDIR: "/certs"

build-image:
  stage: build
  image: docker:24.0.5
  services:
    - name: docker:24.0.5-dind
      alias: docker
  before_script:  |
    echo "---------------------------------------------------------------------------"
    echo "AntParade GitOps 🐜 - Preparing $CI_JOB_IMAGE image for build tasks"
    echo "---------------------------------------------------------------------------"
    echo Installing dependencies (bash git)...
    - apk add --no-cache bash git
    # - ls -l "$DOCKER_CERT_PATH"  # Debug: Show certs
  script:  |
    echo "Building Docker image $DOCKER_IMAGE:$DOCKER_TAG..."
    docker build -t "$DOCKER_IMAGE:$DOCKER_TAG" .
    echo "Logging into the Docker Hub (docker.io)..."
    echo "$DOCKER_HUB_PASSWORD" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin
    echo "Uploading $DOCKER_IMAGE:$DOCKER_TAG to the Docker Hub (docker.io)..."
    docker push "$DOCKER_IMAGE:$DOCKER_TAG"
  rules:
    - if: $CI_COMMIT_TAG

create-release:
  before_script:  |
    echo "---------------------------------------------------------------------------"
    echo "AntParade GitOps 🐜 - Preparing $CI_JOB_IMAGE image for release creation tasks"
    echo "---------------------------------------------------------------------------"
    echo "Installing dependencies (bash curl jq)..."
    apk add --no-cache bash curl jq
  image: alpine:3.22.1
  needs:
    - job: generate_release_notes
      artifacts: true
  only:
    - tags
  script:  |
    echo "Reading $DOCKER_HUB_USERNAME/$CI_PROJECT_NAME's changelog into memory..."
    RELEASE_NOTES=$(cat release.md)

    echo "Creating Gitlab release- $DOCKER_HUB_USERNAME/$CI_PROJECT_NAME:$CI_COMMIT_TAG..."
    curl --header "PRIVATE-TOKEN: $GITLAB_TOKEN" --request POST \
      --form "name=Release $CI_COMMIT_TAG" \
      --form "tag_name=$CI_COMMIT_TAG" \
      --form "description=$RELEASE_NOTES" \
      "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases" || echo "Release might already exist"

    DOCKER_IMAGE_LINK="https://hub.docker.com/r/$DOCKER_HUB_USERNAME/$CI_PROJECT_NAME/tags?page=1&name=$CI_COMMIT_TAG"

    echo "✅ Docker image assumed pushed: $DOCKER_IMAGE_LINK"

    echo "Adding a link to $DOCKER_HUB_USERNAME/$CI_PROJECT_NAME:$CI_COMMIT_TAG via the Docker Hub on the generated Gitlab release page..."
    curl --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
      --request POST \
      --header "Content-Type: application/json" \
      --data "{\"name\":\"Docker Image $CI_COMMIT_TAG\",\"url\":\"$DOCKER_IMAGE_LINK\",\"link_type\":\"other\"}" \
      "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases/$CI_COMMIT_TAG/assets/links"
  stage: release

generate_release_notes:
  artifacts:
    paths:
      - release.md
    expire_in: 1 hour
  before_script:
    - chmod +x ./scripts/release-notes.sh
  image: alpine:3.22.1
  only:
    - tags
  script: |
    echo "Generating release notes for $DOCKER_HUB_USERNAME/$CI_PROJECT_NAME:$CI_COMMIT_TAG..."
    - apk add --no-cache git bash
    - ./scripts/release-notes.sh > release.md
  stage: release